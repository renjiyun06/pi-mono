<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Understand — Quiz Yourself on Code</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a2e;
    --accent: #e94560;
    --accent-dim: rgba(233, 69, 96, 0.15);
    --green: #4ade80;
    --green-dim: rgba(74, 222, 128, 0.15);
    --yellow: #fbbf24;
    --text: #e0e0e0;
    --text-dim: #888;
    --border: #1a1a2e;
    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }
  .container { max-width: 760px; margin: 0 auto; padding: 24px; }

  /* Header */
  header { text-align: center; padding: 40px 0 32px; }
  header h1 {
    font-size: 2rem; font-weight: 800; letter-spacing: -0.02em;
    background: linear-gradient(135deg, #fff 0%, var(--accent) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  header p { color: var(--text-dim); margin-top: 8px; font-size: 0.95rem; }

  /* Setup */
  .setup { margin-bottom: 24px; }
  .setup label { display: block; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 6px; }
  .setup input {
    width: 100%; padding: 10px 14px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-family: var(--mono); font-size: 0.85rem;
  }
  .setup input:focus { outline: none; border-color: var(--accent); }
  .setup .hint { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }
  .setup .hint a { color: var(--accent); text-decoration: none; }

  /* Code input */
  .code-section { margin-bottom: 24px; }
  .code-section textarea {
    width: 100%; height: 300px; padding: 16px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px; color: var(--text);
    font-family: var(--mono); font-size: 0.8rem; line-height: 1.5; resize: vertical;
  }
  .code-section textarea:focus { outline: none; border-color: var(--accent); }
  .code-section .row {
    display: flex; gap: 12px; margin-bottom: 8px; align-items: flex-end;
  }
  .code-section .row > div { flex: 1; }
  .code-section .row > div:first-child { flex: 2; }

  /* Buttons */
  .btn {
    padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer;
    font-size: 0.95rem; font-weight: 600; transition: all 0.15s;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { box-shadow: 0 4px 16px rgba(233, 69, 96, 0.4); transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); }

  /* Status */
  .status {
    padding: 12px 16px; border-radius: 8px; margin: 16px 0;
    font-size: 0.9rem; display: none;
  }
  .status.loading { display: block; background: var(--accent-dim); color: var(--accent); }
  .status.error { display: block; background: rgba(239, 68, 68, 0.15); color: #ef4444; }

  /* Quiz */
  .quiz { display: none; }
  .quiz.active { display: block; }
  .question-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 24px; margin-bottom: 20px;
  }
  .question-card .q-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
  }
  .question-card .q-num {
    font-size: 0.8rem; color: var(--accent); font-weight: 600;
    background: var(--accent-dim); padding: 4px 10px; border-radius: 20px;
  }
  .question-card .q-text { font-size: 1.05rem; margin-bottom: 16px; line-height: 1.5; }
  .question-card .hint-toggle {
    font-size: 0.85rem; color: var(--accent); cursor: pointer; margin-bottom: 12px;
    user-select: none;
  }
  .question-card .hint-text {
    font-size: 0.85rem; color: var(--text-dim); padding: 8px 12px;
    background: var(--accent-dim); border-radius: 6px; margin-bottom: 12px; display: none;
  }
  .question-card textarea {
    width: 100%; height: 80px; padding: 12px; background: var(--bg);
    border: 1px solid var(--border); border-radius: 8px; color: var(--text);
    font-family: inherit; font-size: 0.9rem; resize: vertical;
  }
  .question-card textarea:focus { outline: none; border-color: var(--accent); }

  /* Feedback */
  .feedback {
    margin-top: 12px; padding: 12px 16px; border-radius: 8px;
    font-size: 0.9rem; display: none;
  }
  .feedback.show { display: block; }
  .feedback .score {
    font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;
  }
  .feedback .score.high { color: var(--green); }
  .feedback .score.mid { color: var(--yellow); }
  .feedback .score.low { color: var(--accent); }
  .feedback .fb-text { color: var(--text-dim); }
  .feedback .missed { margin-top: 8px; font-size: 0.85rem; color: var(--text-dim); }

  /* Results */
  .results {
    text-align: center; padding: 32px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 12px; display: none;
  }
  .results.show { display: block; }
  .results .final-score {
    font-size: 3rem; font-weight: 800; margin: 16px 0;
  }
  .results .final-score.high { color: var(--green); }
  .results .final-score.mid { color: var(--yellow); }
  .results .final-score.low { color: var(--accent); }
  .results p { color: var(--text-dim); }
  .results .again { margin-top: 24px; }

  /* Footer */
  footer {
    text-align: center; padding: 32px 0; color: var(--text-dim); font-size: 0.8rem;
  }
  footer a { color: var(--accent); text-decoration: none; }

  @media (max-width: 600px) {
    .code-section .row { flex-direction: column; }
    header h1 { font-size: 1.6rem; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <h1>Understand</h1>
    <p>Paste code. Get quizzed. Know what you shipped.</p>
  </header>

  <!-- Setup -->
  <div class="setup" id="setup">
    <label for="apiKey">OpenRouter API Key</label>
    <input type="password" id="apiKey" placeholder="sk-or-v1-..." autocomplete="off">
    <div class="hint">
      Free at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a>.
      Key stays in your browser — never sent anywhere except OpenRouter.
    </div>
  </div>

  <!-- Code Input -->
  <div class="code-section" id="codeSection">
    <div class="row">
      <div>
        <label for="filename" style="display:block;font-size:0.85rem;color:var(--text-dim);margin-bottom:6px">Filename</label>
        <input type="text" id="filename" placeholder="e.g. auth/session.ts" style="width:100%;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--mono);font-size:0.85rem">
      </div>
      <div>
        <label style="display:block;font-size:0.85rem;color:var(--text-dim);margin-bottom:6px">&nbsp;</label>
        <button class="btn btn-primary" id="generateBtn" onclick="generate()">Generate Quiz</button>
      </div>
    </div>
    <textarea id="codeInput" placeholder="Paste your code here..."></textarea>
  </div>

  <!-- Status -->
  <div class="status" id="status"></div>

  <!-- Quiz -->
  <div class="quiz" id="quiz"></div>

  <!-- Results -->
  <div class="results" id="results">
    <div style="font-size:0.9rem;color:var(--text-dim)">Overall Score</div>
    <div class="final-score" id="finalScore"></div>
    <p id="resultMsg"></p>
    <div class="again">
      <button class="btn btn-secondary" onclick="reset()">Try Another File</button>
    </div>
  </div>

  <footer>
    <p>Understand — an anti-cognitive-debt tool.<br>
    Your code and API key never leave your browser (except to OpenRouter for LLM calls).<br>
    <a href="https://github.com/renjiyun06/pi-mono/tree/autopilot-0008/lamarck/projects/understand">Source</a></p>
  </footer>

</div>

<script>
const MODEL = "anthropic/claude-sonnet-4";
let questions = [];
let scores = [];

function getApiKey() {
  return document.getElementById("apiKey").value.trim();
}

function setStatus(type, msg) {
  const el = document.getElementById("status");
  el.className = "status " + type;
  el.textContent = msg;
}

function clearStatus() {
  const el = document.getElementById("status");
  el.className = "status";
  el.textContent = "";
}

async function callLLM(messages) {
  const key = getApiKey();
  if (!key) { setStatus("error", "Please enter your OpenRouter API key."); return null; }

  const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method: "POST",
    headers: { "Authorization": "Bearer " + key, "Content-Type": "application/json" },
    body: JSON.stringify({ model: MODEL, messages, temperature: 0.3, max_tokens: 2000 }),
  });
  
  if (!res.ok) {
    const err = await res.text();
    setStatus("error", "API error: " + res.status + " — " + err.slice(0, 200));
    return null;
  }
  
  const data = await res.json();
  if (!data.choices?.[0]?.message?.content) {
    setStatus("error", "Unexpected API response: " + JSON.stringify(data).slice(0, 200));
    return null;
  }
  return data.choices[0].message.content;
}

async function generate() {
  const code = document.getElementById("codeInput").value.trim();
  const filename = document.getElementById("filename").value.trim() || "unknown.ts";
  
  if (!code) { setStatus("error", "Please paste some code first."); return; }
  if (code.length < 50) { setStatus("error", "Code seems too short. Paste at least a few functions."); return; }
  
  document.getElementById("generateBtn").disabled = true;
  setStatus("loading", "Analyzing code and generating questions...");
  
  const prompt = `You are a code comprehension evaluator. Given the following code file, generate exactly 3 understanding questions that test whether the developer truly understands what this code does.

Rules:
- Questions should test UNDERSTANDING, not memorization (don't ask "what is the variable name on line 5")
- Focus on: purpose, control flow, edge cases, design decisions, and potential bugs
- Each question should be answerable in 1-3 sentences
- Include a hint that points the developer in the right direction without giving the answer
- Include key concepts that a correct answer should mention

File: ${filename}

\`\`\`
${code.slice(0, 8000)}
\`\`\`

Respond in JSON format:
[
  {
    "question": "...",
    "hint": "...",
    "key_concepts": ["concept1", "concept2"]
  }
]

Return ONLY the JSON array, no markdown formatting.`;

  const response = await callLLM([{ role: "user", content: prompt }]);
  document.getElementById("generateBtn").disabled = false;
  
  if (!response) return;
  
  try {
    const cleaned = response.replace(/^```json?\n?/m, "").replace(/\n?```$/m, "").trim();
    questions = JSON.parse(cleaned);
  } catch (e) {
    setStatus("error", "Failed to parse questions. Try again.");
    return;
  }
  
  if (!Array.isArray(questions) || questions.length === 0) {
    setStatus("error", "No questions generated. Try again.");
    return;
  }
  
  clearStatus();
  scores = [];
  renderQuiz(code);
}

function renderQuiz(code) {
  document.getElementById("codeSection").style.display = "none";
  document.getElementById("setup").style.display = "none";
  
  const quizEl = document.getElementById("quiz");
  quizEl.innerHTML = "";
  quizEl.classList.add("active");
  
  questions.forEach((q, i) => {
    const card = document.createElement("div");
    card.className = "question-card";
    card.innerHTML = `
      <div class="q-header">
        <span class="q-num">Question ${i + 1} of ${questions.length}</span>
      </div>
      <div class="q-text">${escapeHtml(q.question)}</div>
      <div class="hint-toggle" onclick="toggleHint(${i})">Show hint</div>
      <div class="hint-text" id="hint-${i}">${escapeHtml(q.hint)}</div>
      <textarea id="answer-${i}" placeholder="Your answer..."></textarea>
      <button class="btn btn-primary" style="margin-top:12px" id="submit-${i}" onclick="submitAnswer(${i})">Submit Answer</button>
      <div class="feedback" id="feedback-${i}"></div>
    `;
    quizEl.appendChild(card);
  });
  
  // Store code for evaluation
  window._quizCode = code;
}

function toggleHint(i) {
  const hint = document.getElementById("hint-" + i);
  hint.style.display = hint.style.display === "none" ? "block" : "none";
}

function escapeHtml(str) {
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

async function submitAnswer(i) {
  const answer = document.getElementById("answer-" + i).value.trim();
  if (!answer) return;
  
  const btn = document.getElementById("submit-" + i);
  btn.disabled = true;
  btn.textContent = "Evaluating...";
  
  const q = questions[i];
  const code = window._quizCode;
  
  const prompt = `You are evaluating a developer's understanding of code they are working with.

Question: ${q.question}
Key concepts a correct answer should mention: ${q.key_concepts.join(", ")}

Developer's answer: "${answer}"

Relevant code context (first 4000 chars):
\`\`\`
${code.slice(0, 4000)}
\`\`\`

Score the answer 0-10:
- 0-3: Doesn't understand the code
- 4-6: Partial understanding, missing key concepts
- 7-8: Good understanding with minor gaps
- 9-10: Excellent, demonstrates deep understanding

Respond in JSON:
{
  "score": <number>,
  "feedback": "<1-2 sentences explaining the score>",
  "missed": ["<concepts they missed, if any>"]
}

Return ONLY the JSON, no markdown.`;

  const response = await callLLM([{ role: "user", content: prompt }]);
  
  if (!response) { btn.disabled = false; btn.textContent = "Submit Answer"; return; }
  
  let evaluation;
  try {
    const cleaned = response.replace(/^```json?\n?/m, "").replace(/\n?```$/m, "").trim();
    evaluation = JSON.parse(cleaned);
  } catch {
    btn.textContent = "Error parsing — try again";
    btn.disabled = false;
    return;
  }
  
  scores[i] = evaluation.score;
  
  const fb = document.getElementById("feedback-" + i);
  const scoreClass = evaluation.score >= 7 ? "high" : evaluation.score >= 4 ? "mid" : "low";
  fb.innerHTML = `
    <div class="score ${scoreClass}">${evaluation.score}/10</div>
    <div class="fb-text">${escapeHtml(evaluation.feedback)}</div>
    ${evaluation.missed?.length ? `<div class="missed">Missed: ${evaluation.missed.map(escapeHtml).join(", ")}</div>` : ""}
  `;
  fb.className = "feedback show";
  fb.style.background = evaluation.score >= 7 ? "var(--green-dim)" : evaluation.score >= 4 ? "rgba(251,191,36,0.1)" : "var(--accent-dim)";
  
  btn.style.display = "none";
  document.getElementById("answer-" + i).disabled = true;
  
  // Check if all answered
  if (scores.filter(s => s !== undefined).length === questions.length) {
    showResults();
  }
}

function showResults() {
  const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
  const pct = Math.round(avg * 10);
  const cls = pct >= 70 ? "high" : pct >= 40 ? "mid" : "low";
  
  const el = document.getElementById("results");
  document.getElementById("finalScore").textContent = pct + "%";
  document.getElementById("finalScore").className = "final-score " + cls;
  
  let msg;
  if (pct >= 80) msg = "You understand this code well. Ship with confidence.";
  else if (pct >= 60) msg = "Decent understanding, but some gaps. Review the missed concepts.";
  else if (pct >= 40) msg = "Significant gaps in understanding. Take time to study this code before relying on it.";
  else msg = "You may be shipping code you don't understand. This is cognitive debt accumulating.";
  
  document.getElementById("resultMsg").textContent = msg;
  el.classList.add("show");
}

function reset() {
  questions = [];
  scores = [];
  document.getElementById("codeInput").value = "";
  document.getElementById("filename").value = "";
  document.getElementById("quiz").innerHTML = "";
  document.getElementById("quiz").classList.remove("active");
  document.getElementById("results").classList.remove("show");
  document.getElementById("codeSection").style.display = "block";
  document.getElementById("setup").style.display = "block";
  clearStatus();
}

// Restore API key from localStorage
document.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("understand-api-key");
  if (saved) document.getElementById("apiKey").value = saved;
  
  document.getElementById("apiKey").addEventListener("change", (e) => {
    localStorage.setItem("understand-api-key", e.target.value);
  });
});
</script>
</body>
</html>
